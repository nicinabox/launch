#!/usr/bin/env ruby

require 'json'

class Launch
  def initialize(args)
    case args[0]
    when 'remove'
      remove(args[1])
    when 'add'
      add(args[1], args[2])
    when 'list'
      all_services
    else
      open(args[0])
    end
  end

  def config
    ENV['HOME'] ||= File.expand_path('~')
    @config ||= JSON.parse(File.read(launchrc))
  end

  def launchrc
    "#{ENV['HOME']}/.launchrc"
  end

  def all_services
    services = config['services']
    puts services.keys
  end

  def open(service)
    services = config['services']
    aliases  = config['aliases']

    service = aliases[service] if aliases.include? service
    port = services[service]

    puts "Launching #{service}"

    if /^:/ =~ port
      `open http://#{config['host']}#{port}`
    else
      `open http://#{port}`
    end
  end

  def add(name, url)
    config['services'][name] = url
    File.open(launchrc, 'w') do |f|
      f.write JSON.pretty_generate(config)
    end
  end

  def remove(name)
    config['services'].delete(name)
    File.open(launchrc, 'w') do |f|
      f.write JSON.pretty_generate(config)
    end
  end
end

Launch.new ARGV
